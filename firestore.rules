rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // User Rules
    match /users/{userId} {
      allow get: if request.auth != null;
      allow list: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && request.auth.uid == userId;
    }

    // Workspace Rules
    match /workspaces/{workspaceId} {
      function getRole() {
        return resource.data.membersMap[request.auth.uid];
      }

      // Read: Allowed if user is in memberIds array
      allow read: if request.auth != null && (request.auth.uid in resource.data.memberIds);
      
      // Create: Any authenticated user
      allow create: if request.auth != null;

      // Update: Admin OR Joining Flow
      allow update: if request.auth != null && (
        getRole() == 'Admin' || 
        (request.resource.data.memberIds.hasAll(resource.data.memberIds) && 
         request.auth.uid in request.resource.data.memberIds &&
         request.resource.data.membersMap[request.auth.uid] == 'Member')
      );
      
      allow delete: if request.auth != null && getRole() == 'Admin';
    }

    // Invite Rules
    match /invites/{inviteCode} {
      // Get: Any authenticated user can read to validate (needed for join)
      allow get: if request.auth != null;
      
      // Create/Delete: Must be authenticated
      // Ideally, create is restricted to Admin of the workspaceId in request.resource.data
      allow create: if request.auth != null && 
        get(/databases/$(database)/documents/workspaces/$(request.resource.data.workspaceId)).data.membersMap[request.auth.uid] == 'Admin';
      
      // Delete: Either Admin of the workspace OR the user who just joined
      allow delete: if request.auth != null; 
    }
  }
}
